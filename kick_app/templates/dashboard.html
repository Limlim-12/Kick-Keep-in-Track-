{% extends "base.html" %}

{% block content %}

{% if announcements %}
<div class="mb-4">
    <h3 class="h4">Announcements</h3>
    {% for ann in announcements %}
    <div class="alert alert-info shadow-sm" role="alert">
        <h5 class="alert-heading">Posted by {{ ann.author.full_name }} ({{ ann.created_at | pht }})</h5>
        <p style="white-space: pre-wrap;">{{ ann.message }}</p>
    </div>
    {% endfor %}
</div>
<hr>
{% endif %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Dashboard</h1>
</div>

{% if current_user.role.value == 'Admin' %}
<div class="row">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Total Tickets (Today)</h5>
                <h2 class="card-text" id="admin-total-today">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">Open Tickets (All)</h5>
                <h2 class="card-text" id="admin-total-open">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning text-dark mb-3">
            <div class="card-body">
                <h5 class="card-title">In Progress (All)</h5>
                <h2 class="card-text" id="admin-total-inprogress">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Resolved (Today)</h5>
                <h2 class="card-text" id="admin-total-resolved">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header">Ticket Status Breakdown (All Time)</div>
            <div class="card-body">
                <canvas id="statusPieChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header">Tickets per TSR (Open)</div>
            <div class="card-body">
                <canvas id="tsrBarChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row">
    <div class="col-md-3">
        <div class="card text-white bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">My Open Tickets</h5>
                <h2 class="card-text" id="tsr-total-open">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning text-dark mb-3">
            <div class="card-body">
                <h5 class="card-title">My In-Progress</h5>
                <h2 class="card-text" id="tsr-total-inprogress">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Resolved (Today)</h5>
                <h2 class="card-text" id="tsr-resolved-today">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <h5 class="card-title">Avg Resolve (Mins)</h5>
                <h2 class="card-text" id="tsr-avg-resolve-time">0.00</h2>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Use Fetch API to get data from our new endpoint
        fetch('{{ url_for("api.dashboard_stats") }}')
            .then(response => response.json())
            .then(data => {
                if (data.role === 'admin') {
                    // --- Populate Admin Stat Cards ---
                    document.getElementById('admin-total-today').textContent = data.stats.total_today;
                    document.getElementById('admin-total-open').textContent = data.stats.total_open;
                    document.getElementById('admin-total-inprogress').textContent = data.stats.total_inprogress;
                    document.getElementById('admin-total-resolved').textContent = data.stats.total_resolved;

                    // --- Build Admin Pie Chart (Ticket Status) ---
                    const pieCtx = document.getElementById('statusPieChart').getContext('2d');
                    new Chart(pieCtx, {
                        type: 'doughnut',
                        data: {
                            labels: data.pie_chart.labels,
                            datasets: [{
                                label: 'Ticket Status',
                                data: data.pie_chart.data,
                                backgroundColor: [
                                    'rgba(220, 53, 69, 0.7)',  // Open (danger)
                                    'rgba(255, 193, 7, 0.7)', // In Progress (warning)
                                    'rgba(13, 202, 240, 0.7)', // Pending (info)
                                    'rgba(25, 135, 84, 0.7)', // Resolved (success)
                                ],
                                borderColor: [
                                    'rgba(220, 53, 69, 1)',
                                    'rgba(255, 193, 7, 1)',
                                    'rgba(13, 202, 240, 1)',
                                    'rgba(25, 135, 84, 1)',
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    });

                    // --- Build Admin Bar Chart (Tickets per TSR) ---
                    const barCtx = document.getElementById('tsrBarChart').getContext('2d');
                    new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: data.bar_chart.labels,
                            datasets: [{
                                label: 'Open/In-Progress Tickets',
                                data: data.bar_chart.data,
                                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                                borderColor: 'rgba(0, 123, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            indexAxis: 'y', // Makes it a horizontal bar chart
                            scales: {
                                x: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false // Hide legend for simple bar chart
                                }
                            }
                        }
                    });

                } else if (data.role === 'tsr') {
                    // --- Populate TSR Stat Cards ---
                    document.getElementById('tsr-total-open').textContent = data.stats.total_open;
                    document.getElementById('tsr-total-inprogress').textContent = data.stats.total_inprogress;
                    document.getElementById('tsr-resolved-today').textContent = data.stats.total_resolved;
                    document.getElementById('tsr-avg-resolve-time').textContent = data.stats.avg_resolution_time;

                    // --- Build TSR Line Chart (Weekly Performance) ---
                    const lineCtx = document.getElementById('tsrPerfChart').getContext('2d');
                    new Chart(lineCtx, {
                        type: 'line',
                        data: {
                            labels: data.line_chart.labels,
                            datasets: [{
                                label: 'Tickets Resolved',
                                data: data.line_chart.data,
                                fill: false,
                                borderColor: 'rgba(25, 135, 84, 1)', // Success color
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error fetching dashboard data:', error));
    });
</script>
{% endblock %}