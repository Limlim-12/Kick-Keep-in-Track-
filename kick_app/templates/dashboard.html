{% extends "base.html" %}

{% block content %}

{% if announcements %}
<div class="mb-4">
    <h3 class="h4">Announcements</h3>
    {% for ann in announcements %}
    <div class="alert alert-info shadow-sm" role="alert">
        <h5 class="alert-heading">Posted by {{ ann.author.full_name }} ({{ ann.created_at | pht }})</h5>
        <p style="white-space: pre-wrap;">{{ ann.message }}</p>
    </div>
    {% endfor %}
</div>
<hr>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Dashboard</h1>
</div>

<form method="GET" action="{{ url_for('main.index') }}" class="mb-4 p-3 bg-light border rounded">
    <div class="row g-3 align-items-end">
        <div class="col-md-5">
            <label for="start_date" class="form-label">Start Date</label>
            {# Pre-fill value from request args if available, otherwise leave empty #}
            <input type="date" class="form-control" id="start_date" name="start_date"
                value="{{ request.args.get('start_date', '') }}">
        </div>
        <div class="col-md-5">
            <label for="end_date" class="form-label">End Date</label>
            {# Pre-fill value from request args if available, otherwise leave empty #}
            <input type="date" class="form-control" id="end_date" name="end_date"
                value="{{ request.args.get('end_date', '') }}">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Update View</button>
        </div>
    </div>
</form>

{% if current_user.role.value == 'Admin' %}
<div class="row">
    {# --- Adjusted columns to col-md-2 to fit 6 cards --- #}
    <div class="col-md-2">
        <div class="card text-white bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Created (Range)</h5> {# Renamed title #}
                <h2 class="card-text" id="admin-total-created">0</h2> {# Changed ID #}
            </div>
        </div>
    </div>
    {# --- ADDED NEW Card --- #}
    <div class="col-md-2">
        <div class="card text-white bg-secondary mb-3">
            <div class="card-body">
                <h5 class="card-title">New (All)</h5>
                <h2 class="card-text" id="admin-total-new">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">Open (All)</h5>
                <h2 class="card-text" id="admin-total-open">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-warning text-dark mb-3">
            <div class="card-body">
                <h5 class="card-title">In Progress (All)</h5>
                <h2 class="card-text" id="admin-total-inprogress">0</h2>
            </div>
        </div>
    </div>
    {# --- ADDED PENDING Card --- #}
    <div class="col-md-2">
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <h5 class="card-title">Pending (All)</h5>
                <h2 class="card-text" id="admin-total-pending">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Resolved (Range)</h5> {# Renamed title #}
                <h2 class="card-text" id="admin-total-resolved">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card shadow-sm mb-3"> {# Added mb-3 #}
            <div class="card-header">Ticket Status Breakdown (All Time)</div>
            <div class="card-body">
                <canvas id="statusPieChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm mb-3"> {# Added mb-3 #}
            <div class="card-header">Tickets per TSR (Open/In-Progress)</div> {# Updated Title slightly #}
            <div class="card-body">
                <canvas id="tsrBarChart"></canvas>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row">
    {# --- Adjusted columns to fit more cards, e.g., col-md-4 for 3 per row or col-md-2 for 6 --- #}
    {# --- ADDED NEW Card --- #}
    <div class="col-md-4 col-lg-2"> {# Responsive columns #}
        <div class="card text-white bg-secondary mb-3">
            <div class="card-body">
                <h5 class="card-title">My New</h5>
                <h2 class="card-text" id="tsr-total-new">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2"> {# Responsive columns #}
        <div class="card text-white bg-danger mb-3">
            <div class="card-body">
                <h5 class="card-title">My Open</h5>
                <h2 class="card-text" id="tsr-total-open">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2"> {# Responsive columns #}
        <div class="card text-white bg-warning text-dark mb-3">
            <div class="card-body">
                <h5 class="card-title">My In-Progress</h5>
                <h2 class="card-text" id="tsr-total-inprogress">0</h2>
            </div>
        </div>
    </div>
    {# --- ADDED PENDING Card --- #}
    <div class="col-md-4 col-lg-2"> {# Responsive columns #}
        <div class="card text-white bg-info mb-3">
            <div class="card-body">
                <h5 class="card-title">My Pending</h5>
                <h2 class="card-text" id="tsr-total-pending">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2"> {# Responsive columns #}
        <div class="card text-white bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Resolved (Range)</h5> {# Renamed title #}
                <h2 class="card-text" id="tsr-resolved-range">0</h2> {# Changed ID #}
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-2"> {# Responsive columns #}
        <div class="card text-dark bg-light mb-3"> {# Changed color #}
            <div class="card-body">
                <h5 class="card-title">Avg Resolve (Mins)</h5>
                <h2 class="card-text" id="tsr-avg-resolve-time">0.00</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header">My Performance (Tickets Resolved in Range)</div> {# Renamed title #}
            <div class="card-body">
                <canvas id="tsrPerfChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- START OF FIX: Read date filters from URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const startDate = urlParams.get('start_date');
        const endDate = urlParams.get('end_date');

        // Build the API URL dynamically
        let apiUrl = '{{ url_for("api.dashboard_stats") }}';
        if (startDate && endDate) {
            apiUrl += `?start_date=${startDate}&end_date=${endDate}`;
        }
        // --- END OF FIX ---

        // Use the dynamic apiUrl in the fetch
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data.role === 'admin') {
                    // --- Populate Admin Stat Cards ---
                    // --- START OF FIX: Use correct JSON key 'total_created' ---
                    document.getElementById('admin-total-created').textContent = data.stats.total_created;
                    // --- END OF FIX ---
                    document.getElementById('admin-total-new').textContent = data.stats.total_new; // <-- Add NEW
                    document.getElementById('admin-total-open').textContent = data.stats.total_open;
                    document.getElementById('admin-total-inprogress').textContent = data.stats.total_inprogress;
                    document.getElementById('admin-total-pending').textContent = data.stats.total_pending; // <-- Add PENDING
                    document.getElementById('admin-total-resolved').textContent = data.stats.total_resolved;

                    // --- Build Admin Pie Chart ---
                    const pieCtx = document.getElementById('statusPieChart').getContext('2d');
                    new Chart(pieCtx, {
                        type: 'doughnut',
                        data: {
                            labels: data.pie_chart.labels,
                            datasets: [{
                                label: 'Ticket Status',
                                data: data.pie_chart.data,
                                backgroundColor: [
                                    'rgba(108, 117, 125, 0.7)', // New (secondary) - Added
                                    'rgba(220, 53, 69, 0.7)',  // Open (danger)
                                    'rgba(255, 193, 7, 0.7)', // In Progress (warning)
                                    'rgba(13, 202, 240, 0.7)', // Pending (info)
                                    'rgba(25, 135, 84, 0.7)', // Resolved (success)
                                ],
                                borderColor: [ // Added border for New
                                    'rgba(108, 117, 125, 1)',
                                    'rgba(220, 53, 69, 1)',
                                    'rgba(255, 193, 7, 1)',
                                    'rgba(13, 202, 240, 1)',
                                    'rgba(25, 135, 84, 1)',
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                            }
                        }
                    });

                    // --- Build Admin Bar Chart ---
                    const barCtx = document.getElementById('tsrBarChart').getContext('2d');
                    new Chart(barCtx, {
                        type: 'bar',
                        data: {
                            labels: data.bar_chart.labels,
                            datasets: [{
                                label: 'Open/In-Progress Tickets',
                                data: data.bar_chart.data,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1 // Ensure Y-axis shows whole numbers
                                    }
                                }
                            }
                        }
                    });


                } else if (data.role === 'tsr') {
                    // --- Populate TSR Stat Cards ---
                    document.getElementById('tsr-total-new').textContent = data.stats.total_new; // <-- Add NEW
                    document.getElementById('tsr-total-open').textContent = data.stats.total_open;
                    document.getElementById('tsr-total-inprogress').textContent = data.stats.total_inprogress;
                    document.getElementById('tsr-total-pending').textContent = data.stats.total_pending; // <-- Add PENDING
                    // --- START OF FIX: Use correct ID ---
                    document.getElementById('tsr-resolved-range').textContent = data.stats.total_resolved;
                    // --- END OF FIX ---
                    document.getElementById('tsr-avg-resolve-time').textContent = data.stats.avg_resolution_time;

                    // --- Build TSR Line Chart ---
                    const lineCtx = document.getElementById('tsrPerfChart').getContext('2d');
                    new Chart(lineCtx, {
                        type: 'line',
                        data: {
                            labels: data.line_chart.labels,
                            datasets: [{
                                label: 'Tickets Resolved',
                                data: data.line_chart.data,
                                fill: false,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1 // Ensure Y-axis shows whole numbers
                                    }
                                }
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error fetching dashboard data:', error));
    });
</script>
{% endblock %}